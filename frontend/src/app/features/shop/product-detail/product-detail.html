<div class="min-h-screen bg-white pb-32">
  @if (product(); as p) {
    <!-- Image Header -->
    <div class="relative h-[50vh] w-full bg-spirit-background overflow-hidden rounded-b-[3rem] shadow-lg">
      <!-- Remplacement de NgOptimizedImage par une balise img standard pour éviter les warnings de ratio -->
      <!-- NgOptimizedImage est strict sur les ratios, ce qui est compliqué avec des images dynamiques de tailles variées -->
      <img [src]="p.imageUrl" class="h-full w-full object-cover" [alt]="p.name">

      <!-- Bouton RETOUR amélioré -->
      <button routerLink="/boutique" class="absolute top-6 left-6 px-4 py-2 bg-white/90 backdrop-blur-md rounded-full flex items-center gap-2 text-spirit-primary shadow-md z-10 hover:bg-white transition-colors">
        <mat-icon class="text-sm">arrow_back</mat-icon>
        <span class="text-sm font-bold">Retour boutique</span>
      </button>

      <button class="absolute top-6 right-6 h-10 w-10 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-spirit-primary shadow-sm z-10">
        <mat-icon>favorite_border</mat-icon>
      </button>
    </div>

    <!-- Contenu -->
    <div class="px-6 -mt-10 relative z-10">
      <div class="bg-white rounded-[2rem] p-6 shadow-xl shadow-spirit-primary/5 border border-spirit-primary/5">
        <div class="flex justify-between items-start mb-2">
          <div>
            <h1 class="font-serif text-2xl text-spirit-primary">{{ p.name }}</h1>
            <p class="text-xs uppercase tracking-widest text-gray-400 font-bold mt-1">{{ p.stone }}</p>
          </div>
          <!-- Prix dynamique -->
          <span class="text-2xl font-bold text-spirit-primary">{{ displayPrice() }}€</span>
        </div>

        <!-- Badges d'info -->
        <div class="flex flex-wrap gap-2 mt-4 mb-6">
          @if (p.type === 'PHYSICAL') {
            <span class="px-3 py-1 bg-spirit-primary/5 text-spirit-primary text-xs rounded-full font-medium">Produit Physique</span>
          } @else {
            <span class="px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full font-medium">Service</span>
          }

          @if (selectedVariant()?.durationMonths || p.durationMonths) {
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">Durée : {{ selectedVariant()?.durationMonths || p.durationMonths }} mois</span>
          }
          @if (displaySessionCount()) {
            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">{{ displaySessionCount() }} séance(s)</span>
          }
        </div>

        <!-- SÉLECTION DES VARIANTES -->
        @if (p.variants && p.variants.length > 0) {
          <div class="mb-6">
            <h3 class="text-sm font-bold text-gray-700 mb-3">Choisissez votre formule :</h3>
            <div class="flex flex-col gap-3">
              @for (variant of p.variants; track variant.id) {
                <button (click)="selectVariant(variant)"
                        class="flex justify-between items-center p-4 rounded-xl border-2 transition-all text-left"
                        [class.border-spirit-primary]="selectedVariant()?.id === variant.id"
                        [class.bg-spirit-primary-50]="selectedVariant()?.id === variant.id"
                        [class.border-gray-100]="selectedVariant()?.id !== variant.id">
                  <div>
                    <span class="block font-bold text-spirit-primary">{{ variant.label }}</span>
                    <span class="text-xs text-gray-500">{{ variant.sessionCount }} séances • {{ variant.durationMonths }} mois</span>
                  </div>
                  <span class="font-bold text-spirit-primary">{{ variant.price }}€</span>
                </button>
              }
            </div>
          </div>
        }

        <!-- CALENDRIER DE RÉSERVATION (Pour tout ce qui n'est pas physique) -->
        @if (p.type !== 'PHYSICAL') {
          <div class="mb-8 animate-in fade-in slide-in-from-bottom-4">
            <h3 class="text-lg font-serif text-spirit-primary mb-2">
              {{ displaySessionCount() && displaySessionCount()! > 1 ? 'Réserver la 1ère séance' : 'Choisir un créneau' }}
            </h3>
            <app-booking-calendar (slotSelected)="onSlotSelected($event)"></app-booking-calendar>
            @if (displaySessionCount() && displaySessionCount()! > 1) {
              <p class="text-xs text-gray-500 mt-2 italic">Les séances suivantes seront planifiées ultérieurement.</p>
            }
          </div>
        }

        <p class="text-gray-600 leading-relaxed text-sm">
          {{ p.description || "Ce bracelet unique a été conçu pour harmoniser vos énergies. Chaque pierre a été sélectionnée avec soin pour ses vertus lithothérapeutiques." }}
        </p>
      </div>
    </div>

    <!-- Actions (Sticky Bottom) -->
    <div class="fixed bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-100 z-[60] pb-8">
      <button (click)="addToCart()"
              [disabled]="p.type !== 'PHYSICAL' && !selectedAppointment()"
              class="w-full py-4 bg-spirit-primary text-white rounded-2xl font-bold shadow-xl shadow-spirit-primary/20 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <mat-icon>shopping_bag</mat-icon>
        {{ (p.type !== 'PHYSICAL' && !selectedAppointment()) ? 'Choisir un créneau' : 'Ajouter au panier' }}
      </button>
    </div>

  } @else {
    <div class="h-screen flex items-center justify-center">
      <div class="animate-spin h-8 w-8 border-2 border-spirit-primary border-t-transparent rounded-full"></div>
    </div>
  }
</div>
