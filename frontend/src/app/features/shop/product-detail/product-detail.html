<div class="min-h-screen bg-white pb-32">
    @if (product(); as p) {
        <div class="relative h-[50vh] w-full bg-spirit-background overflow-hidden rounded-b-[3rem] shadow-lg">
            <img [src]="p.imageUrl" class="h-full w-full object-cover" [alt]="p.name">

            <button
                routerLink="/boutique"
                class="absolute top-6 left-6 px-4 py-2 bg-white/90 backdrop-blur-md rounded-full flex items-center gap-2 text-spirit-primary shadow-md z-10 hover:bg-white transition-colors"
            >
                <mat-icon class="text-sm">arrow_back</mat-icon>
                <span class="text-sm font-bold">Retour boutique</span>
            </button>
        </div>

        <div class="px-6 -mt-10 relative z-10">
            <div class="bg-white rounded-[2rem] p-6 shadow-xl shadow-spirit-primary/5 border border-spirit-primary/5">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h1 class="font-serif text-2xl text-spirit-primary">{{ p.name }}</h1>
                        @if (p.stones && p.stones.length > 0) {
                            <div class="flex flex-wrap gap-2 mt-2">
                                @for (stone of p.stones; track stone.id) {
                                    <span
                                        class="px-3 py-1 bg-spirit-accent text-spirit-primary text-xs rounded-full font-medium"
                                    >
                                        {{ stone.name }}
                                    </span>
                                }
                            </div>
                        }
                    </div>
                    <div class="text-right">
                        <span class="text-2xl font-bold text-spirit-primary">{{ displayPrice() }}€</span>
                        @if (p.isSubscription) {
                            <span class="block text-xs font-medium text-gray-500 uppercase tracking-wide">
                                / {{ p.recurringInterval === 'month' ? 'mois' : (p.recurringInterval === 'year' ? 'an' : p.recurringInterval) }}
                            </span>
                        }
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 mt-4 mb-6">
                    @if (p.type === 'PHYSICAL') {
                        <span
                            class="px-3 py-1 bg-spirit-primary/5 text-spirit-primary text-xs rounded-full font-medium"
                        >Bijou</span>
                    } @else if (p.isSubscription) {
                        <span
                            class="px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full font-medium flex items-center gap-1"
                        >
                            <mat-icon class="text-[10px] h-3 w-3">autorenew</mat-icon> Abonnement
                        </span>
                    } @else {
                        <span
                            class="px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full font-medium"
                        >Service</span>
                    }

                    @if (selectedVariant()?.durationMonths || p.durationMonths) {
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">
                            Durée : {{ selectedVariant()?.durationMonths || p.durationMonths }} mois
                        </span>
                    }
                    @if (displaySessionCount()) {
                        <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                            {{ displaySessionCount() }} séance(s)
                        </span>
                    }
                </div>

                @if (p.variants && p.variants.length > 0) {
                    <div class="mb-6">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">Choisissez votre formule :</h3>
                        <div class="flex flex-col gap-3">
                            @for (variant of p.variants; track variant.id) {
                                <button
                                    (click)="selectVariant(variant)"
                                    class="flex justify-between items-center p-4 rounded-xl border-2 transition-all text-left"
                                    [class.border-spirit-primary]="selectedVariant()?.id === variant.id"
                                    [class.bg-spirit-primary-50]="selectedVariant()?.id === variant.id"
                                    [class.border-gray-100]="selectedVariant()?.id !== variant.id"
                                >
                                    <div>
                                        <span class="block font-bold text-spirit-primary">{{ variant.label }}</span>
                                        <span class="text-xs text-gray-500">{{ variant.sessionCount }}
                                            séances • {{ variant.durationMonths }} mois</span>
                                    </div>
                                    <span class="font-bold text-spirit-primary">{{ variant.price }}€</span>
                                </button>
                            }
                        </div>
                    </div>
                }

                @if (p.type === 'PHYSICAL' && p.sizes && p.sizes.length > 0) {
                    <div class="mb-6">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">Choisissez votre taille :</h3>
                        <div class="flex flex-col gap-3">
                            @for (size of p.sizes; track size.id) {
                                <button
                                    (click)="selectSize(size)"
                                    class="flex justify-between items-center p-4 rounded-xl border-2 transition-all text-left"
                                    [class.border-spirit-primary]="selectedSize()?.id === size.id"
                                    [class.bg-spirit-primary-50]="selectedSize()?.id === size.id"
                                    [class.border-gray-100]="selectedSize()?.id !== size.id"
                                >
                                    <div>
                                        <span class="block font-bold text-spirit-primary">{{ size.label }}</span>
                                        <span class="text-xs text-gray-500">{{ size.description }}</span>
                                    </div>
                                </button>
                            }
                        </div>
                    </div>
                }

                @if (p.type !== 'PHYSICAL' && !p.isSubscription) {
                    <div class="mb-8 animate-in fade-in slide-in-from-bottom-4">
                        <h3 class="text-lg font-serif text-spirit-primary mb-2">
                            {{ (displaySessionCount() ?? 0) > 1 ? 'Réserver la 1ère séance' : 'Choisir un créneau' }}
                        </h3>
                        <app-booking-calendar
                            [bufferMinutes]="p.bufferTimeMinutes || 0"
                            (slotSelected)="onSlotSelected($event)"
                        >
                        </app-booking-calendar>
                    </div>
                }

                <p class="text-gray-600 leading-relaxed text-sm">
                    {{ p.description || "Description en cours de rédaction..." }}
                </p>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-100 z-[60] pb-8">
            <button
                (click)="addToCart()"
                [disabled]="(p.type !== 'PHYSICAL' && !p.isSubscription && !selectedAppointment()) || (p.type === 'PHYSICAL' && p.sizes && p.sizes.length > 0 && !selectedSize())"
                class="w-full py-4 bg-spirit-primary text-white rounded-2xl font-bold shadow-xl shadow-spirit-primary/20 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <mat-icon>shopping_bag</mat-icon>
                <span>
                    @if (p.type !== ProductDTO.TypeEnum.Physical && !p.isSubscription && !selectedAppointment()) {
                        Choisir un créneau
                    } @else if (p.type === ProductDTO.TypeEnum.Physical && p.sizes && p.sizes.length > 0 && !selectedSize()) {
                        Choisir une taille
                    } @else if (p.isSubscription) {
                        S'abonner
                    } @else {
                        Ajouter au panier
                    }
                </span>
            </button>
        </div>

    } @else {
        <div class="h-screen flex items-center justify-center">
            <div class="animate-spin h-8 w-8 border-2 border-spirit-primary border-t-transparent rounded-full"></div>
        </div>
    }
</div>
